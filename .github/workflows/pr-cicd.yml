name: Pintos Test CI

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ë ˆí¼ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: QEMU ë° ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            gcc \
            g++ \
            make \
            perl \
            python3

          if [ -f /usr/bin/qemu-system-i386 ]; then
            sudo ln -sf /usr/bin/qemu-system-i386 /usr/bin/qemu
          elif [ -f /usr/bin/qemu-system-x86_64 ]; then
            sudo ln -sf /usr/bin/qemu-system-x86_64 /usr/bin/qemu
          fi

          qemu --version

      - name: Pintos í™˜ê²½ í™œì„±í™”
        shell: bash
        run: |
          source ./activate
          echo "$GITHUB_WORKSPACE/utils" >> "$GITHUB_PATH"

      - name: Pintos í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ìš”ì•½ ìƒì„±
        env:
          PINTOSOPTS: -v
        run: |
          set +e

          projects=(vm)

          echo "## ğŸš€ Pintos CI Report" > test-summary.md
          echo "" >> test-summary.md
          echo "**ì»¤ë°‹ SHA:** \`${{ github.event.pull_request.head.sha }}\`" >> test-summary.md
          echo "" >> test-summary.md

          grand_pass=0
          grand_total=0

          for project in "${projects[@]}"; do
            echo "::group::í…ŒìŠ¤íŠ¸ ì‹¤í–‰: $project"

            if [ -d "$project" ]; then
              cd "$project"

              make clean
              if ! make; then
                echo "### â›” $project - ë¹Œë“œ ì‹¤íŒ¨" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                cd "$GITHUB_WORKSPACE"
                echo "::endgroup::"
                continue
              fi

              cd build
              make check VERBOSE=1 || true

              result_files=$(find tests -name '*.result' 2>/dev/null | sort)
              total=$(echo "$result_files" | wc -l | tr -d ' ')

              if [ "$total" -eq 0 ]; then
                echo "### âš ï¸ $project - í…ŒìŠ¤íŠ¸ ì—†ìŒ" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
              else
                pass=0
                fail=0

                echo "### ğŸ“‚ $project" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "<details>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "<summary><b>í…ŒìŠ¤íŠ¸ ëª©ë¡ (ì´ ${total}ê°œ)</b> â€” í¼ì¹˜ë ¤ë©´ í´ë¦­</summary>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"

                for result_file in $result_files; do
                  test_name=$(basename "$result_file" .result)
                  if grep -q "PASS" "$result_file" 2>/dev/null; then
                    echo "- ğŸŸ¢ \`$test_name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                    pass=$((pass + 1))
                  else
                    echo "- ğŸ”´ \`$test_name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                    fail=$((fail + 1))
                  fi
                done

                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "</details>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"

                pass_rate=$(awk "BEGIN {printf \"%.1f%%\", ($pass/$total)*100}")
                echo "**ìš”ì•½:** $pass / $total í†µê³¼ ($pass_rate)" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"

                grand_pass=$((grand_pass + pass))
                grand_total=$((grand_total + total))
              fi

              cd "$GITHUB_WORKSPACE"
            fi

            echo "::endgroup::"
          done

          if [ "$grand_total" -gt 0 ]; then
            grand_pass_rate=$(awk "BEGIN {printf \"%.1f%%\", ($grand_pass/$grand_total)*100}")
            echo "---" >> test-summary.md
            echo "" >> test-summary.md
            echo "## ğŸ“Š ì „ì²´ ê²°ê³¼" >> test-summary.md
            echo "" >> test-summary.md
            echo "**${grand_pass} / ${grand_total}** í…ŒìŠ¤íŠ¸ í†µê³¼ (${grand_pass_rate})" >> test-summary.md
          fi

          echo "" >> test-summary.md
          echo "_ìƒì„± ì‹œê°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> test-summary.md

          cat test-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "ğŸš€ Pintos CI Report"

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: test-summary.md
          edit-mode: replace

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pintos-test-results
          path: |
            */build/tests/**/*.output
            */build/tests/**/*.result
            test-summary.md
          retention-days: 7
